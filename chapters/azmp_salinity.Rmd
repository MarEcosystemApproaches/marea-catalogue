
<!-- Indicator Chapter for azmp_salinity: Surface Salinity -->


```{r setup-azmp_salinity, include=FALSE}
library(marea)
library(dplyr)
knitr::opts_chunk$set(echo = F, message = F)
indicator <- "azmp_salinity"

# get metadata & data for this variable
data <- get(data(list = indicator, package = 'marea'))
```



<!------- Header Section -------------->
<!-- Title -->
# Surface Salinity (AZMP)

<!-- Metadata -->
**Data Type:** Tabular Data

**Spatial Scope:** Scotian Shelf (4X, 4V, 4W)

**Duration** `r marea_metadata() %>% filter(Dataset == indicator) %>% pull(TimeSpan)`

**Source:** `r data@meta$source_citation` 

<!--**Contact:** ADD CONTACT-->



<!----------- Intro Section -------------->
## Introduction to Indicator
<!-- ADD DESCRIPTION -->

AZMP Surface Salinity is the spatially-averaged salinity value from Atlantic Zone Monitoring Program (AZMP) monitoring stations at 0m depth, spatially and temporally summarized to annual values for the Scotian Shelf region (NAFO zones 4X, 4V, 4W). 

Surface salinity in this region is driven by several factors, including inflow of rivers, melting of sea ice, precipitation, and advection by wind and ocean currents [@canada2025azmp]. Interannual changes in salinity in the Scotian Shelf region are linked to changes in these processes, and could be indicative of changes to biology in the region [@grodsky2017interannual].


<!----------- Plots Section -------------->
## View Data
<!-- USE DEFAULT MAREA PLOT OR REPLACE WITH CUSTOM -->
```{r plot-azmp_salinity, echo=TRUE}
library(plotly)
plotly_df <- data@data %>%
  mutate( 
    smooth_10yr = zoo::rollapply(mean_value, mean, width = 10, partial = TRUE),
    overall_mean = mean(mean_value))

p <- plot_ly(plotly_df, x = ~year) %>%
  add_lines(y = ~mean_value,
            name = "Annual Mean",
            line = list(color = "grey"),
            hovertemplate = "Monthly anomaly: %{y:.2f}<extra></extra>"
           ) %>%
  add_lines(y = ~smooth_10yr,
            name = "10-yr Smooth",
            line = list(color = "blue", width = 2),
            hovertemplate = "10-yr smoothed: %{y:.2f}<extra></extra>",
            ) %>%
    add_lines(y = ~overall_mean,
            name = "Overall Mean",
            line = list(color = "black", width = 2, dash = "dash"),
            hovertemplate = "Overall Mean: %{y:.2f}<extra></extra>",
           ) %>%
  layout(
    title = "AZMP Surface Salinity for Scotial Shelf (4X, 4V, 4W)<br><sup>Source: DFO Atlantic Zone Monitoring Program via azmpdata</sup>",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Salinity (PSU)",
                 fixedrange = TRUE),
    hovermode = "x unified",
    margin = list( t = 80)
    
  ) %>%
  config(displayModeBar = FALSE) 

p


```



<!----------- Trends Section -------------->
## Trends
<!-- ADD SPECIFICATION TO DEFAULTS -->

```{r calc-trends-azmp_salinity, include=F}

# assess dataset
# find the most recent recoded value, and its relation to broader data:
last_row <- last(data@data)
value_col <- colnames(data@data)[first(which(stringr::str_detect(colnames(data@data), "value")))]
has_months <- "month" %in% colnames(last_row)
has_regions <- "region" %in% colnames(last_row)

# calculate most recent value
last_date <- ifelse(has_months,
                        paste0(last_row$month,"/",last_row$year),
                        paste0(last_row$year))
last_val <- last(data@data)[[value_col]]
last_percentile <- round(ecdf(data@data[[value_col]])(last_val) * 100,2)

# calculate trend over the last 10 years
max_year <- max(data@data$year)
max_year_minus_ten <- max_year - 10
min_year <- min(data@data$year)
last_ten <- data@data[data@data$year %in% c((max_year_minus_ten):max_year),]
last_ten_mod <- lm(last_ten[[value_col]] ~ c(1:nrow(last_ten)))
last_ten_slope <- last_ten_mod$coefficients[[2]]
last_ten_slope <- ifelse(has_months, last_ten_slope * 12, last_ten_slope)
last_ten_direction <- ifelse(last_ten_slope > 0,"increased","decreased")
last_ten_p <- summary(last_ten_mod)$coefficients[2,"Pr(>|t|)"]
last_ten_p_annotate <-
      if(last_ten_p <= .01) "Very Strong" else
        if(last_ten_p <= .05) "Strong" else
          if(last_ten_p <= .1) "Marginal" else
            "Nonsignificant"
last_ten_p_annotate2 <-
      if(last_ten_p <= .01) "p < 0.01" else
        if(last_ten_p <= .05) "p < 0.05" else
          if(last_ten_p <= .1) "p < 0.1" else
            "p > 0.1"



# calculate trend over full timeseries
full_mod <- lm(data@data[[value_col]] ~ c(1:nrow(data@data)))
full_mod_slope <- full_mod$coefficients[[2]]
full_mod_slope <- ifelse(has_months,full_mod_slope * 12, full_mod_slope)
full_mod_p <- summary(full_mod)$coefficients[2,"Pr(>|t|)"]
full_mod_p_annotate <-
      if(full_mod_p <= .01) "Very Strong" else
        if(full_mod_p <= .05) "Strong" else
          if(full_mod_p <= .1) "Marginal" else
            "Nonsignificant"
full_mod_p_annotate2 <-
      if(full_mod_p <= .01) "p < 0.01" else
        if(full_mod_p <= .05) "p < 0.05" else
          if(full_mod_p <= .1) "p < 0.1" else
            "p > 0.1"
full_mod_direction <- ifelse(full_mod_slope > 0,"increased","decreased")



# calculate highest point in time series
highest_row <- data@data[which.max(data@data[[value_col]]),]
highest_timepoint <- ifelse(has_months,
                                paste0(highest_row$month,"/",highest_row$year),
                                highest_row$year)
highest_val <- highest_row[[value_col]]



# calculate lowest point in time series
lowest_row <- data@data[which.min(data@data[[value_col]]),]
lowest_timepoint <- ifelse(has_months,
                               paste0(lowest_row$month,"/",lowest_row$year),
                               lowest_row$year)
lowest_val <- lowest_row[[value_col]]



# find current values
current_trend <- ifelse(last_ten_slope > 0,"increasing", "decreasing")
current_magnitude <-
      if(last_percentile > 70) "high" else
        if(last_percentile < 30) "low" else
          "moderate"



# find overall mean
overall_mean <-  mean(data@data[[value_col]])
highest_vs_mean <- round(highest_val - overall_mean,2)
lowest_vs_mean <- round(overall_mean - lowest_val,2)



# find whether the current value is above or below the mean, and how long it has been
current_vs_mean <- last_val - overall_mean
current_vs_mean_text <- ifelse(sign(current_vs_mean) == 1,"above","below")
last_different_sign <- switch(current_vs_mean_text,
                                  "above" = last(which(data@data[value_col] < overall_mean)),
                                  "below" = last(which(data@data[value_col] > overall_mean)))
last_date_different_sign <- ifelse(has_months,
                                       paste0(data@data[last_different_sign,"month"],"/",data@data[last_different_sign,"year"]),
                                       paste0(data@data[last_different_sign,"year"]))

```



<!---------- Trends Text ----------->
As of the most recent data entry in **`r last_date`**, the AZMP Surface Salinity value is `r last_val` PSU, which is **`r current_magnitude`** among values in the timeseries.
The Surface Salinity value is currently **`r current_vs_mean_text` the long-term mean**, and has been **since `r last_date_different_sign`**.
The regional salinity value has followed a **`r current_trend` trend** in recent years.



<!--------- Trends Table--------->
### Summary Table
|Metric      |Value     |Description          |
|:-----------|:---------|:--------------------|
|Most Recent Value (`r last_date`)  | `r last_val` |The most recent value is **`r current_magnitude`** within the timeseries, in the `r last_percentile` percentile of all values. The most recent value is `r abs(round(current_vs_mean,2))` `r current_vs_mean_text` the long-term mean.|
|Recent Trend (`r max_year_minus_ten` -- `r max_year`)  | `r round(last_ten_slope,3)` per year | In the last ten years, azmp_salinity has **`r last_ten_direction`** by `r round(last_ten_slope,3)` per year with a **`r last_ten_p_annotate` trend** (`r last_ten_p_annotate2`). |
|Overall Trend (`r min_year` -- `r max_year`)  | `r round(full_mod_slope,3)` per year | Since the beginning of the timeseries, azmp_salinity has **`r full_mod_direction`** by `r round(full_mod_slope,3)` per year with a **`r full_mod_p_annotate` trend** (`r full_mod_p_annotate2`). |
|Highest Value | `r highest_val` | The highest value in the timeseries was recorded on **`r highest_timepoint`**, and was **`r highest_vs_mean`** higher than the overall timeseries mean. |
|Lowest Value | `r lowest_val` | The lowest value in the timeseries was recorded on **`r lowest_timepoint`**, and was **`r lowest_vs_mean`** lower than the overall timeseries mean. |



<!----------- Relevance Section -------------->
## Relevance to Research and Stock Assessments
<!-- ADD RELEVANCE-->

Most harvested species are not expected to be sensitive to salinity within the range of observed or near-future projected values in Northwest Atlantic[@chabot2013review]. Thus, salinity perhaps has the greatest potential relevance to stocks and fisheries through indirect effects, via changes in surface productivity and stratification. 

In the Gulf of Maine-Scotian Shelf region, freshening events are associated with changes in the timing and magnitude of springtime phytoplankton blooms, ultimately reducing primary productivity in coastal waters [@ji2008modeling]. These changes in primary productivity can propagate to secondary productivity, which make up large portions of larval diets for commercially important species [@becker2020review].



<!----------- Column Definitions Section -------------->
## Variable Definitions

|variable   |description |unit |
|:----------|:-----------|:----|
|year       |Year of data collection          |  |
|region     |Region of summarization (one value)         |  |
|mean_value |Spatially and temporally averaged salinity for Scotian Shelf region         | PSU  |



<!----------- Data Access Section -------------->
## Get the Data
```{r get-data-azmp_salinity, include=T, echo=T, eval=F}
library(marea)
data('azmp_salinity')
plot(azmp_salinity)
```
