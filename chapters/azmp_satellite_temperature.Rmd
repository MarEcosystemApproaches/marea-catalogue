
<!-- Indicator Chapter for azmp_satellite_temperature: Surface Temperature from Satellite -->


```{r setup-azmp_satellite_temperature, include=FALSE}
library(marea)
library(dplyr)
knitr::opts_chunk$set(echo = F, message = F)
indicator <- "azmp_satellite_temperature"

# get metadata & data for this variable
data <- get(data(list = indicator, package = 'marea'))
```



<!------- Header Section -------------->
<!-- Title -->
# Surface Temperature from Satellite Data (AZMP)

<!-- Metadata -->
**Data Type:** Tabular Data

**Spatial Scope:** Scotian Shelf (4X, 4V, 4W)

**Duration** `r marea_metadata() %>% filter(Dataset == indicator) %>% pull(TimeSpan)`

**Source:** `r data@meta$source_citation` 

<!--**Contact:** ADD CONTACT-->



<!----------- Intro Section -------------->
## Introduction to Indicator
<!-- ADD DESCRIPTION -->

Sea surface temperature from satellite data refers to continuous sea surface temperature (SST) fields derived from satellite sensors, representing the temperature of the ocean's surface. Here, continuous fields are summarized within non-mutually exclusive regions representing NAFO zones or subzone divisions. 

Sea surface temperature is influenced by a variety of conditions spanning multiple spatial and temporal scales. In this region, long-term trends in SST are consistent with expectations of anthropogenic climate change [@greenan2019changes]. At the same time, decadal-to-interannual regional SST trends are influenced by atmospheric indicators like those described in this book, and short-term local values can be influenced by many oceanographic and climate factors, such as freshwater input, ocean currents, and weather events.

<!----------- Plots Section -------------->
## View Data
<!-- USE DEFAULT MAREA PLOT OR REPLACE WITH CUSTOM -->
```{r plot-azmp_satellite_temperature, echo=TRUE}
library(plotly)
plotly_df <- azmp_satellite_temperature@data
plot_ly(data = plotly_df, x= ~year, colors = "Set1") %>%
  add_lines(y = ~mean_value,
            color = ~region,
            text = ~paste0("<b>",region,"</b>: ",round(mean_value,2),"°C"),
            hoverinfo = "x+text",
            line = list(width = 2)) %>%
    layout(
    title = "Surface Tmperature from Satellite for Scotian Shelf (4X, 4V, 4W)",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Sea Surface Temperature (°C)",
                 fixedrange = T),
    hovermode = "x unified"
  ) %>%
  config(displayModeBar = FALSE)


```



<!----------- Trends Section -------------->
## Trends
<!-- ADD SPECIFICATION TO DEFAULTS -->

```{r calc-trends-azmp_satellite_temperature, include=F}

 # get value colname
value_col <- colnames(data@data)[first(which(stringr::str_detect(colnames(data@data), "value")))]



# calculate mean per region
region_means <- data@data %>%
      group_by(region) %>%
      summarize(mean = mean(get(value_col)),
                sd = sd(get(value_col)),
                .groups = "drop") %>%
      mutate(region = forcats::fct_reorder(region, mean))
 # find overall mean
overall_mean <- data@data %>%
      summarize(mean = mean(get(value_col))) %>% pull(mean)



# find trends per region
data_split <-  data@data  %>% split(f =  data@data$region)
data_split_mods <- purrr::map(.x = data_split,
                                  .f = ~lm(.x, formula = get(value_col) ~ year))
# find coefficients per region
data_coefficients <- 
  purrr::map(.x = data_split_mods,
             .f = ~coefficients(.x)[[2]] %>% as_tibble) %>%
      bind_rows(.id = "region") %>%
      rename(trend = value)
# find confidence intervals
data_confints <- 
  purrr::map(.x = data_split_mods,
             .f = ~confint(.x)[2,] %>%
               setNames(c("lower","upper"))) %>%
  bind_rows(.id = "region")
# find p values per region
data_p_values <- purrr::map(.x = data_split_mods,
                                .f = ~summary(.x)$coefficients[2,"Pr(>|t|)"] %>% as_tibble) %>%
      bind_rows(.id = "region") %>%
      rename(p_val = value)


# merge
merge <- region_means %>% 
  merge(data_coefficients) %>%
  merge(data_confints) %>%
  merge(data_p_values) %>%
  arrange(region)

# plot
slopes_p <- merge %>%
      ggplot( aes(x = region, y = mean,
                  ymin = (mean - sd), ymax = (mean + sd),
                  color = trend)) +
      geom_hline(yintercept = overall_mean, linetype = "dashed") +
      geom_pointrange(linewidth = 1) +
      geom_text(data = . %>% filter(p_val < 0.05),
                label = "*", nudge_y = 2, size = 6, color = "black") +
      scale_color_gradient2(low = "cornflowerblue", mid = "grey80",high = "tomato2") +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
labs(x = NULL,
           y = "Surface Temperature from Satellite",
           color = "Temporal Trend",
           title = "Mean values per region")



# plot
slopes_p2 <- merge %>%
      ggplot( aes(x = region, y = trend,
                  ymin = lower, ymax = upper,
                  color = mean)) +
      geom_hline(yintercept = 0, linetype = "dashed") +
      geom_pointrange(linewidth = 1) +
      geom_text(data = . %>% filter(p_val < 0.05),
                label = "*", nudge_y = mean(merge$upper - merge$trend)*2, size = 6, color = "black") +
      scale_color_viridis_c() +
      theme_bw() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
labs(x = "Region; arranged by mean temperature",
           y = "Surface Temperature Trend (°C/year)",
           color = "Mean\nTemperature\n(°C)",
           title = "Temperature Trend (°C/year)")




# find number of regions increasing and decreasing
n_regions <- length(unique(data@data$region))
n_increasing <- sum(data_coefficients$trend > 0)
n_decreasing <- sum(data_coefficients$trend < 0)
n_significant <- sum(merge$p_val < 0.05)
majority_trend <- ifelse(n_increasing > n_decreasing, "increasing","decreasing")

# find highest and lowest regions
highest_region <- as.character(merge$region[which.max(merge$mean)])
highest_mean <- round(merge$mean[merge$region == highest_region],2)
lowest_region <- as.character(merge$region[which.min(merge$mean)])
lowest_mean <- round(merge$mean[merge$region == lowest_region],2)
highest_trend_region <-  as.character(merge$region[which.max(merge$trend)])
lowest_trend_region <-  as.character(merge$region[which.min(merge$trend)])



# find mean quantile of most recent value
last_year <- max(data@data$year)
data_split_last <- purrr::map(
      .x = data_split,
      .f = ~last(.x)
    )
last_percentile <- purrr::map2(
      .x = data_split,
      .y = data_split_last,
      .f = ~round(ecdf(.x[[value_col]])(.y[[value_col]]) * 100,2) %>%
        as_tibble
    ) %>%
      bind_rows(.id = "region") %>%
      rename(percentile = value)
last_percentile_groups <- last_percentile %>%
      summarize(n_high = sum(percentile > 70 ),
                n_mid = sum(percentile > 30 & percentile < 70),
                n_low = sum(percentile < 30))
last_percentile_mean <- last_percentile %>% summarize(mean = mean(percentile))

```


Surface temperatures area less variable across the region compared to bottom temperature. Among regions in this dataset, mean surface temperatures range from **`r highest_mean` in `r highest_region`** to **`r lowest_mean` in `r lowest_region`**. 


```{r plot-trends-azmp_satellite_temperature, echo=F}
slopes_p2
```


The overall trend is **`r majority_trend`** across regions. `r n_increasing` regions have increasing Surface Temperature from Satellite trends and `r n_decreasing` have negative trends. `r n_significant` of these trends are statistically significant over time.


```{r plot-trends-azmp_satellite_temperature-map, echo=F}
library(sf)
library(mapgl)

# get shapefiles for regions
sf <- readRDS("data/derived_data/azmp_area.rds") %>%
  filter(get(indicator) == T)

sf_merge <- sf %>%
  select(area, area_type, geometry) %>%
  rename(region = area) %>%
  # merge in modeled values
  left_join(merge) 

# make color scale for trends - symmetrical around zero
maxtrend <- max(abs(sf_merge$trend))
scale_data <- data.frame(trend = c(sf_merge$trend, -maxtrend, maxtrend))
trend_color_scale <- interpolate_palette(
  data = scale_data,
  column = "trend",
  method = "equal",
  n = 5, 
  palette = function(n) rev(RColorBrewer::brewer.pal(n, "RdBu"))  
)


# make color scale for means
mean_color_scale <- interpolate_palette(
  data = sf_merge,
  column = "mean",    
  method = "equal",
  n = 4,
  palette = viridisLite::viridis
)

# make popup label
sf_merge <- sf_merge %>%
  mutate(label = paste(
      "<span style='font-size: 12px;'><b>",region, "</b><br>",
      "<b>Timeseries Mean:</b>", round(mean,2),"°C<br>",
      "<b>Temperature Trend:</b>", round(trend,3),"°C/year<br>",
      "<b>p_val:</b>", ifelse(p_val<0.05,"<0.05", round(p_val,2)),
      "<br>"
    )) %>%
    mutate(label2 = paste0(
    '<div style="',
    'font-size: 11px; ',
    'line-height: 1.5em',
    '">',label,
    '</div>'))


m1 <- maplibre(center = c(-62, 44),
         zoom = 4.5)  |> 
  # add filled polygons
  add_fill_layer(
    id = "warming_trend",
    source = sf_merge,
    fill_color = trend_color_scale$expression,
    fill_opacity = 0.6,
    hover_options = list(fill_opacity = 1,
                         fill_color =  trend_color_scale$expression),
    tooltip = "label2"
  ) |>
  # add solid outlines for significant trends
  add_line_layer(
    "sig_polygons",
    source = sf_merge %>% filter(p_val <= 0.05),
    line_color = "black",
    line_width = 1
  ) |>
  # add dashed outlines for nonsig trends
  add_line_layer(
    "nonsig_polygons",
    source = sf_merge %>% filter(p_val > 0.05),
    line_color = "black",
    line_dasharray = c(5,2),
    line_width = 1
  ) |>
  # add legend
  add_legend(
    "Warming Trend (°C/year)<br><small>Solid outlines indicate significance</small>",
    values = get_legend_labels(trend_color_scale, digits = 2),
    colors = get_legend_colors(trend_color_scale),
    type = "continuous"
  ) 


m2 <- maplibre(center = c(-62, 44),
               zoom = 4.5)  |> 
  # add filled polygons
  add_fill_layer(
    id = "mean_temp",
    source = sf_merge,
    fill_color = mean_color_scale$expression,
    fill_opacity = 0.5,
    hover_options = list(fill_opacity = 1,
                         fill_color =  mean_color_scale$expression),
    tooltip = "label2"
  ) |>
  # add outlines (all same)
  add_line_layer(
    "mean_temp_polygons",
    source = sf_merge %>% filter(p_val <= 0.05),
    line_color = "black",
    line_width = 1
  ) |>
  # add legend
  add_legend(
    legend_title = "Mean Temperature (°C)<br><small>Average value across timeseries</small>",
    values = get_legend_labels(mean_color_scale, digits = 2),
    colors = get_legend_colors(mean_color_scale),
    type = "continuous",
    position = "top-right"
  ) 


# make widget showing both maps with a slider
compare(m1, m2)
  

```

<div style="height: 2rem;"></div>


In the most recent year of sampling (`r last_year`), **`r last_percentile_groups[["n_high"]]` regions had values that are high** compared to their overall timeseries (>70th percentile), **`r last_percentile_groups[["n_mid"]]` regions had values that were moderate** (between 30th and 70th percentile), and **`r last_percentile_groups[["n_low"]]` regions had low values** (<30th percentile) within their timeseries.

<!----------- Relevance Section -------------->
## Relevance to Research and Stock Assessments
<!-- ADD RELEVANCE-->

Changes to sea surface temperature could have great impact on fisheries and stocks from both direct and indirect effects. 

Sea surface temperatures can directly impact fisheries via changes to the distribution and phenology of key fisheries species [@hutchings2012climate]. These changes are likely to result in the loss or decline of some commercially important species, but also the gain or increase of others. Atlantic Canada is projected to experience decreases in species and maximum catch in the Scotian Shelf and surrounding bioregions, but projected gains towards the Arctic [@cheung2010large]. These changes are consistent with expected poleward shifts if species track climatic envelopes towards the poles. Changes to surface temperature might also affect phenological process of key species, including spawning times and predator/prey encounters.

Sea surface temperatures can also affect the physical and chemical properties of marine ecosystems, in turn, affecting species. Warming and freshening of surface waters can lead to increased stratification in coastal oceans, influencing primary productivity and nutrient cycling.



<!----------- Column Definitions Section -------------->
## Variable Definitions

|variable   |description |unit |
|:----------|:-----------|:----|
|year       |Year of data collection         |  |
|region     |NAFO region or subregion         |  |
|mean_value |Regionally summarized sea surface temperature, derived from satellite data         |°C  |



<!----------- Data Access Section -------------->
## Get the Data
```{r get-data-azmp_satellite_temperature, include=T, echo=T, eval=F}
library(marea)
data('azmp_satellite_temperature')
plot(azmp_satellite_temperature)
```
